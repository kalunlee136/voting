function getRandomColor(){for(var e="0123456789ABCDEF".split(""),t="#",o=0;6>o;o++)t+=e[Math.floor(16*Math.random())];return t}var app=angular.module("votingApp",["ui.router"]),doughnutOptions={segmentShowStroke:!0,segmentStrokeColor:"#fff",segmentStrokeWidth:2,percentageInnerCutout:50,animation:!0,animationSteps:100,animationEasing:"easeOutBounce",animateRotate:!0,animateScale:!0,onAnimationComplete:null,legendTemplate:'<ul class="<%=name.toLowerCase()%>-legend"><% for (var i=0; i<segments.length; i++){%><li><span style="background-color:<%=segments[i].fillColor%>"></span><%if(segments[i].label){%><%=segments[i].label%><%}%></li><%}%></ul>'};app.controller("MainCtrl",["$scope","$http","$state","$stateParams","polls","auth",function(e,t,o,l,r,n){e.isLoggedIn=n.isLoggedIn,e.choices=[{loc:0,upvote:0},{loc:1,upvote:0},{loc:2,upvote:0}],e.allPolls=r.allPolls,e.addNewChoice=function(){var t=e.choices.length;e.choices.push({loc:t,upvote:0}),console.log(e.choices)},e.showAddChoice=function(t){return t.loc===e.choices[e.choices.length-1].loc},e.createPoll=function(){var l={title:e.title,choices:e.choices};t.post("/polls",l,{headers:{Authorization:"Bearer "+n.getToken()}}).success(function(e){var t=o.href("polls");window.location.href=t+e._id}).error(function(e){console.log(e)})},e.init=function(){if(localStorage[l.id]){var r=o.href("r",{id:l.id});console.log("url",r,l.id),window.location.href=r}return t.get("/polls/"+l.id).then(function(t){var o=[];e.title1=t.data.title,e.choices1=t.data.choices,e.total=0,e.choices1.forEach(function(t){var l=getRandomColor();o.push({value:t.upvote,label:t.name,color:l}),e.total+=t.upvote});var l=document.getElementById("doughnutChart").getContext("2d"),r=new Chart(l).Doughnut(o,doughnutOptions);document.getElementById("js-legend").innerHTML=r.generateLegend()})},e.submitVote=function(){return e.choiceIndex=$("input[type='radio']:checked").val(),e.choices1[e.choiceIndex].upvote+=1,t.put("/polls/"+l.id,{choices:e.choices1}).success(function(e){console.log(e),localStorage.setItem(l.id,!0);var t=o.href("polls");window.location.href=t+"/r"}).error(function(e){console.log(e)})}}]),app.controller("UserCtrl",["$scope","$http","polls","auth",function(e,t,o,l){e.userPolls=o.userPolls,e.deletePoll=function(e,t){o.deletePoll(e,t)}}]),app.factory("polls",["$http","auth",function(e,t){var o={};return o.allPolls=[],o.userPolls=[],o.showAllPolls=function(){e.get("/polls").then(function(e){angular.copy(e.data,o.allPolls),console.log("getAllUserPolls",e)})},o.getAllUserPolls=function(){e.get("/users/polls",{headers:{Authorization:"Bearer "+t.getToken()}}).then(function(e){angular.copy(e.data,o.userPolls),console.log("getAllUserPolls",e)})},o.deletePoll=function(l,r){e["delete"]("/polls/"+l,{headers:{Authorization:"Bearer "+t.getToken()}}).then(function(e){o.userPolls.slice(r,1)})},o}]),app.controller("AuthCtrl",["$scope","$state","auth",function(e,t,o){e.user={},e.register=function(){o.register(e.user).error(function(t){e.error=t}).then(function(){t.go("home")})},e.logIn=function(){o.logIn(e.user).error(function(t){e.error=t}).then(function(){t.go("home")})}}]),app.controller("NavCtrl",["$scope","auth",function(e,t){e.isLoggedIn=t.isLoggedIn,e.currentUser=t.currentUser,e.logOut=t.logOut}]),app.factory("auth",["$http","$window",function(e,t){var o={};return o.saveToken=function(e){t.localStorage["vote-app-token"]=e},o.getToken=function(){return t.localStorage["vote-app-token"]},o.isLoggedIn=function(){var e=o.getToken();if(e){var l=JSON.parse(t.atob(e.split(".")[1]));return l.exp>Date.now()/1e3}return!1},o.currentUser=function(){if(o.isLoggedIn()){var e=o.getToken(),l=JSON.parse(t.atob(e.split(".")[1]));return l.username}},o.register=function(t){return e.post("/register",t).success(function(e){o.saveToken(e.token)})},o.logIn=function(t){return e.post("/login",t).success(function(e){o.saveToken(e.token)})},o.logOut=function(){t.localStorage.removeItem("vote-app-token")},o}]),app.config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("home",{url:"",views:{header:{templateUrl:"/partials/header.html"},body:{templateUrl:"partials/home.html",controller:"MainCtrl"}},resolve:{pollsPromise:["polls",function(e){e.showAllPolls()}]}}).state("polls",{url:"/polls/:id",views:{header:{templateUrl:"/partials/header.html"},body:{templateUrl:"partials/poll.html",controller:"MainCtrl"}}}).state("r",{url:"/polls/:id/r",views:{body:{templateUrl:"partials/result.html",controller:"MainCtrl"}}}).state("login",{url:"/login",views:{header:{templateUrl:"/partials/header.html"},body:{templateUrl:"partials/login.html",controller:"AuthCtrl"}},onEnter:["$state","auth",function(e,t){t.isLoggedIn()&&e.go("home")}]}).state("register",{url:"/register",views:{header:{templateUrl:"/partials/header.html"},body:{templateUrl:"partials/register.html",controller:"AuthCtrl"}},onEnter:["$state","auth",function(e,t){t.isLoggedIn()&&e.go("home")}]}).state("profile",{url:"/profile",views:{header:{templateUrl:"/partials/header.html"},body:{templateUrl:"partials/profile.html",controller:"UserCtrl"}},resolve:{pollsPromise:["polls",function(e){e.getAllUserPolls()}]}}),t.otherwise("")}]);